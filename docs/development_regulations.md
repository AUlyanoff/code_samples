# РЕГЛАМЕНТ РАЗРАБОТКИ 
модулей MDM-сервера

___

Ваше API не будет безупречным, хотя к этому надо стремиться. Перфекционизм отодвигает сроки реализации. Лучше готово, чем идеально. 
Цель программирования - не создание программы, а получение результатов вычисления. Лучше не делать вовсе, чем делать кое-как.


### 1. Получение ЧТЗ
Нет задачи – нет модуля. Требуйте поставить на себя задачу в TrackStudio, которая должна содержать ссылку на Функциональные требования в GitLab с нетолкуемым описанием входа и выхода (в крайнем случае создайте для себя самостоятельно). Получив претензии Заказчика, начальство склонно утверждать, что они возникли из-за ошибок реализации и неправильного толкования Функциональных требований, поэтому добивайтесь точности.


### 2. Документирование
Модуль должен быть задокументирован Вами в двух местах: в коде и в Описании реализации. 
Строка документации модуля лишь зовётся «строкой», на деле это абзац, содержащий описание цели и задач модуля в терминах бизнес-логики, а также смысла принимаемых параметров и возвращаемых данных. 

Комментарии нужны, чтобы другие люди могли проверять и сопровождать Ваш код, то есть должны раскрывать назначение кода, объясняя, почему он написан именно так. Если Вы намерены продвигать тезис, что код сам себя комментирует, Вам не следует программировать, даже если Вы даёте объектам действительно хорошие имена.

Специалист в другом языке программирования испытает трудности при чтении Вашего кода, несмотря на Строку документации и комментарии. Поэтому Вам следует написать Описание реализации своего модуля.
Отступление от этих требований не допускается.


### 3. Стиль
Код разработчиков одного и того же проекта должен стать похожим. Начать надо с имён переменных и объектов, которые даются строго по PEP8. Имена должны быть лаконичными и отражать назначение объекта, удачные сокращения приветствуются. Для примера сравните два имени для переменной, хранящей интервал времени до сброса количества попыток входа: reset_account_lockout_counter_after и retries_reset_timeout.

Код должен быть легко читаемым. Стремитесь к простоте.

Избегайте оборванных ветвлений (if-ов без else-а). Не выходите из цикла по break-у. Использование нескольких return уместнее скорее для ассемблера, чем для языка высокого уровня. Если функция ничего не возвращает, лучше явно вернуть None. Не меняйте тип данных во время счета. Хорошо, когда модуль (функция) вмещается на один экран, это значительно упрощает бэкпортирование, но не увлекайтесь избыточной декомпозицией. 

ООП прекрасная методика, но не делайте класс из каждой переменной. Стремитесь к тому, чтобы модуль имел один вход и один выход, если только это не ухудшает читаемость. Если это ухудшило функционал, значит Вы неправильно провели декомпозицию. 

Соблюдайте межуровневые протоколы и требуйте их соблюдения от разработчиков прилегающих уровней – список и тип получаемых параметров должен быть постоянным вне зависимости от контекста: если возвращать нечего, всегда можно вернуть пустую строку или None. Опасайтесь использовать None, т.к. это может вызвать непредвиденные ошибки типизации во время счёта.

> Если код короткий или имеется конкретная необходимость, нарушайте всё изложенное. Полагайтесь на внутреннее чувство вкуса - что красиво, то и работает. Воспитайте в себе и пользуйтесь субъективным ощущением чистоты кода. Соблюдение PEP8 является законом разработчика, но если у Вас десятилетний успешный опыт, без колебаний отступайте от закона, если потребуется. 

Не используйте особенности реализации языка или сторонней библиотеки, не используйте недокументированные возможности.


### 4. Особенности проекта
API получает информацию запроса из трёх источников: url, заголовки и json в Body.
В ответ на запрос, API возвращает HTTP код и диагностику в контейнерах json вида {“data”: “<…>“} или {“error”: “<…>“}, а при необходимости и json в Body. Для предотвращения мошенничества в каждый ответ сервером добавляется заголовок X-Frame-Options: DENY, исключающий встраивание во фрейм (выполняет обработчик response_headers_X_Frame_Options).
Научитесь самостоятельно поднимать локальный MDM-сервер, правильно настройте зависимости. Прочитайте конфиги db.yml и iosmdm.yml и убедитесь, что Вы их понимаете. Изучите порядок загрузки MDM-сервера. Овладейте возможностями объектов database, task, flask, config, settings, g. 
Для передачи параметров в модифицируемые функции используйте механизм **kwargs.
Обеспечьте обратную совместимость с Монитором и АРМ, не вводите новых кодов ответа без суровой необходимости. Оградите Монитор от подробной расшифровки ошибок, старайтесь ограничиться стандартными HTTP ответами, допускается добавить в контейнер диагностики «error» числовой код возврата от БД без расшифровки. Расшифровку и все имеющиеся подробности об ошибке направляйте в логи сервера.
Модуль API получает управление из Flask через механизм маршрутизации, реализованный Blueprint. Вызывающей стороной должны быть Монитор или АРМ.
Бизнес-логика реализуется на стороне БД, для чего API вызывает хранимые процедуры (ХП) через объект database. Описание параметров ХП находятся в src/json/procedures/ по категориям.


### 5. Взаимодействие с разработчиками БД
Вы являетесь заказчиком процедур для разработчиков базы данных. Код процедур находится в базе, репозиторий json с описанием параметров (сигнатурами ХП) принадлежит разработчикам базы данных, у нас есть туда доступ на чтение.
Разработчики БД пишут сигнатуры на json и загружают их в свой одноимённый репозитарий, основываясь на наших требованиях, которые мы формулируем из п. 1 настоящего Регламента. Хорошим тоном будет, если Вы включите в требования для «базистов» уже написанную Вами сигнатуру. Они её проверят, согласуют с Вами и добавят в свой репозитарий. Самостоятельное написание сигнатуры обеспечит изначальное понимание интерфейса взаимодействия и облегчит отладку на заглушке ХП. Репозитарий json является частью исходного кода MDM-сервера, и Вы должны следить за его своевременными обновлениями.


### 6. Логирование
Необходимо обеспечить фиксацию старта и окончания функции вместе с входными параметрами и возвращаемыми данными. Конечно, помимо этого существует произвольное количество критических ветвлений и данных, требующих логирования, в любых местах программы.
Логи должны быть легко читаемы. 

Тщательно продумывайте и переводите на английский свои сообщения, они должны быть однообразными в похожих случаях. Внимательно выбирайте переменные для логирования, лишняя информация затрудняет чтение. 

Диагностическое сообщение должно быть информативным и ясно описывать ситуацию. Не всегда краткость сестра таланта: не следует ограничиваться лаконичным "kit not found" - диагностика не должна оставлять места для выяснения, при каких обстоятельствах не найден КИТ, и понятно описывать эти обстоятельства. Например: "HTTP header 'X-MCC-ID' contains an empty string". 

Используйте `<имя функции>.__doc__`.  Соблюдайте [Требования логирования](./logs.md).


### 7. Тестирование
Что не протестировано, то не работает. Одновременно с API Вы должны написать тест на свой код. Тест должен быть структурным, тестируется не «чёрный ящик», а в совершенстве известный текст. Тестовые случаи подбираются так, чтобы отработали все ветви модуля API. Адаптация кода под тесты запрещена, код не должен знать, что тесты существуют. Используется стандартное средство unittest. 

Общая методология такова: API вызывается через тестовый клиент Flask, а все ответы базы данных и иных сторонних сервисов подменяются заглушками, возвращающими ситуативно достоверные данные (их можно взять из дебага заглушаемых процедур). Мы стремимся, с одной стороны, полностью отключить сторонние сервисы, а с другой, вызвать тестами весь код сервера хотя бы один раз. 

Обходитесь минимальным количеством контрольных примеров. Учитывая, что исчерпывающее тестирование невозможно, испытывайте программу разумно.
Тесты автоматически запускаются при загрузке commit-а в удалённый репозиторий.


### 8. Заключение
* Код модуля должен быть короче этого Регламента.
* Всё, что здесь не описано, но требуется, берите из примеров в проекте.
* Сначала делайте багфиксы для Заказчика, потом продающиеся фичи, а рефакторинг последним.
* Соблюдайте поставленные сроки. 
