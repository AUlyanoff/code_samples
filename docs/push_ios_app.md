# Компонент пуш-сервер Монитора iOS
> Кроме системного монитора Apple, предустановленного в iOS, существует приложение,
> разработанное НИИ *****, которое так же называется Монитором. Оно реализует 
> [некоторые недостающие функции](.), и для него 
> существует свой пуш-сервер APNs. Настоящая документация относится к упомянутому
> пуш-серверу, обслуживающему Монитор НИИ *****.
> 
> Системный монитор iOS на сленге проекта ***** и в его документации для
> простоты часто называют просто "устройством", а его пуш-сервер "пуш-сервером устройста".

[Код пуш-сервера](../push_ios_app/push_loop.py) расположен в `scr\monitor_push_http2`, он является частью проекта 
МДМ и совместно использует некоторые его объекты, такие как database и config, 
а так же файл конфигурации iosmdm.yml. При этом сервер имеет отдельную точку входа и 
решается в отдельном docker-контейнере.

Пуш-сервер не является `flask`-приложением, и использует только `http2`-соединения (коннекты) 
для отправки уведомлений (notification) через APNs.

---

### 1. Параметризация
Настройки пуш-сервера Монитора iOS находятся в конфигурационном файле сервера МДМ 
в секции monitorpush.

    # на какой Монитор iOS из списка мониторов /monitors: посылать пуш-уведомление
    monitoruid: ru.safe-phone.Monitor     
    # текст пуш-уведомления в виде словаря формата json
    # push: {"aps": {"alert": "Тест. Вам что-то направлено", "sound": "default"}}  # посылаем обычный alert-пуш
    push: {"aps": {"content-available": 1, "sound": ""}}  # посылаем silent-пуш
    # параметры многопоточности
    threads_allowed: true    # можно ли использовать потоки
    max_threads: 40          # макс кол-во потоков для одновременной посылки пушей (1 пуш = 1 поток)
    terminate_threads: 3     # если потоков слишком много, ждём завершения этого числа потоков
    terminate_timeout: 60.0  # ждём завершения потока не более этого числа секунд

Если `threads_allowed` не задан, сервер  пытается определить, разрешены ли в 
системе потоки, и самостоятельно устанавливает этот параметр. Если опустить остальные 
параметры, они примут значение по умолчанию, как здесь указано. 

### 2. Режимы работы сервера
Сервер работает в двух режимах: последовательном (однопоточном) и асинхронном (многопоточном). 
Выбор между режимами осуществляется на основании значения параметра `threads_allowed`. 
Если параметр отсутствует, сервер проверяет, разрешены ли потоки в системе, и если 
разрешены, переходит в многопоточный режим.


### 3. Последовательный режим работы 
Каждый пуш передаётся в отдельном коннекте (соединении) с APNs. Соединения 
(коннекты) открываются последовательно для каждого пуша, каждый последующий 
коннект открывается после закрытия предыдущего. Этот режим является однопоточным.

Таким образом, скорость ограничивается временем утановления связи с APNs и 
составляет примерно 1 пуш-уведомление за 1-2 секунды.

### 4. Асинхронный режим работы

> В пуш-сервере системного понитора iOS реализована пакетная передача уведомлений, 
> до 500 штук за одно соединение с APNs. 
> Для пуш-сервера Монитора такая стратегия приведёт к перегрузке серверов отдачи файлов. 
> Последовательная реализация является медленной и используется, когда порождение 
> потоков запрещено в системе.
> Асинхронный многопоточный режим является компромиссом между этими двумя.

Сбалансированным подходом можно считать асинхронную передачу пуш-уведомлений, 
реализованную как пул потоков для коннектов: 1 коннект = 1 пуш. Каждое соединение
открывается и закрывается в своём потоке. Этот режим является многопоточным.

Оценочная скорость составляет десятки пуш-уведомлений за 1-2 секунды, что регулируется 
количеством порождаемых потоков - параметр `max_threads`. 
